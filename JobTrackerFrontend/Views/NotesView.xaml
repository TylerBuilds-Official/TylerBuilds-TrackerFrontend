<UserControl x:Class="JobTrackerFrontend.Views.NotesView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:md="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:vm="clr-namespace:JobTrackerFrontend.ViewModels"
             d:DataContext="{d:DesignInstance vm:NotesViewModel}"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d"
             Loaded="OnLoaded">

    <Grid Margin="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Loading -->
        <ProgressBar Grid.Row="0"
                     Style="{StaticResource MaterialDesignLinearProgressBar}"
                     IsIndeterminate="True"
                     Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
                     Height="2" Margin="0,0,0,4"
                     Background="Transparent" BorderThickness="0" />

        <!-- ═══════════════════════════════════ -->
        <!-- Full-width Editor Area              -->
        <!-- ═══════════════════════════════════ -->
        <Grid Grid.Row="1"
              Visibility="{Binding HasActiveNote, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Title Row -->
            <DockPanel Grid.Row="0" Margin="0,0,0,8">
                <!-- Right: Save / Delete -->
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal">
                    <Button Content="Delete"
                            Command="{Binding DeleteNoteCommand}"
                            Style="{StaticResource MaterialDesignOutlinedButton}"
                            Margin="0,0,8,0" Padding="12,4" />
                    <Button Content="Save"
                            Command="{Binding SaveNoteCommand}"
                            Style="{StaticResource MaterialDesignRaisedButton}"
                            Padding="16,4" />
                </StackPanel>

                <!-- Left: Drawer toggle + Title -->
                <Button Command="{Binding ToggleDrawerCommand}"
                        Style="{StaticResource MaterialDesignOutlinedButton}"
                        Padding="6,4" MinWidth="0" Height="Auto"
                        Margin="0,0,8,0"
                        ToolTip="Browse Notes">
                    <md:PackIcon Kind="NoteSearchOutline" Width="20" Height="20" />
                </Button>
                <TextBox Text="{Binding EditingTitle, UpdateSourceTrigger=PropertyChanged}"
                         md:HintAssist.Hint="Note Title"
                         Style="{StaticResource MaterialDesignOutlinedTextBox}"
                         FontSize="16" Margin="0,0,12,0" />
            </DockPanel>

            <!-- Global toggle -->
            <CheckBox Grid.Row="1"
                      Content="Global (visible to all users)"
                      IsChecked="{Binding IsGlobal}"
                      Style="{StaticResource MaterialDesignCheckBox}"
                      Margin="0,0,0,8" />

            <!-- Formatting Toolbar -->
            <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,0,0,4">
                <Button x:Name="BoldButton" Click="Bold_Click"
                        Style="{StaticResource MaterialDesignOutlinedButton}"
                        Padding="6,2" MinWidth="0" Margin="0,0,4,0"
                        ToolTip="Bold">
                    <md:PackIcon Kind="FormatBold" Width="18" Height="18" />
                </Button>
                <Button x:Name="ItalicButton" Click="Italic_Click"
                        Style="{StaticResource MaterialDesignOutlinedButton}"
                        Padding="6,2" MinWidth="0" Margin="0,0,4,0"
                        ToolTip="Italic">
                    <md:PackIcon Kind="FormatItalic" Width="18" Height="18" />
                </Button>
                <Button x:Name="UnderlineButton" Click="Underline_Click"
                        Style="{StaticResource MaterialDesignOutlinedButton}"
                        Padding="6,2" MinWidth="0" Margin="0,0,4,0"
                        ToolTip="Underline">
                    <md:PackIcon Kind="FormatUnderline" Width="18" Height="18" />
                </Button>
                <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}"
                           Margin="4,4" />
                <Button x:Name="BulletButton" Click="Bullet_Click"
                        Style="{StaticResource MaterialDesignOutlinedButton}"
                        Padding="6,2" MinWidth="0" Margin="0,0,4,0"
                        ToolTip="Bullet List">
                    <md:PackIcon Kind="FormatListBulleted" Width="18" Height="18" />
                </Button>
            </StackPanel>

            <!-- Rich Text Editor -->
            <Border Grid.Row="3" BorderBrush="{DynamicResource MaterialDesignDivider}"
                    BorderThickness="1" CornerRadius="4" Margin="0,4,0,0">
                <RichTextBox x:Name="Editor"
                             AcceptsReturn="True"
                             AcceptsTab="True"
                             VerticalScrollBarVisibility="Auto"
                             Padding="8"
                             FontSize="14"
                             BorderThickness="0"
                             TextChanged="Editor_TextChanged">
                    <RichTextBox.Resources>
                        <Style TargetType="Paragraph">
                            <Setter Property="Margin" Value="0,0,0,4" />
                        </Style>
                    </RichTextBox.Resources>
                </RichTextBox>
            </Border>

            <!-- Error -->
            <TextBlock Grid.Row="4"
                       Text="{Binding ErrorMessage}"
                       Foreground="{DynamicResource MaterialDesignValidationErrorBrush}"
                       Visibility="{Binding ErrorMessage, Converter={StaticResource NullToCollapsedConverter}}"
                       Margin="0,8,0,0" TextWrapping="Wrap" />
        </Grid>

        <!-- ═══════════════════════════════════ -->
        <!-- Empty State (no note selected)      -->
        <!-- ═══════════════════════════════════ -->
        <StackPanel Grid.Row="1"
                    VerticalAlignment="Center"
                    HorizontalAlignment="Center"
                    Visibility="{Binding HasActiveNote, Converter={StaticResource InverseBoolToVisConverter}}">
            <md:PackIcon Kind="NoteTextOutline" Width="48" Height="48"
                         HorizontalAlignment="Center" Opacity="0.3" />
            <TextBlock Text="Select a note or create a new one"
                       Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                       Opacity="0.4" Margin="0,12,0,0"
                       HorizontalAlignment="Center" />
            <Button Content="Browse Notes"
                    Command="{Binding ToggleDrawerCommand}"
                    Style="{StaticResource MaterialDesignOutlinedButton}"
                    Margin="0,16,0,0"
                    HorizontalAlignment="Center">
                <Button.ContentTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal">
                            <md:PackIcon Kind="NoteSearchOutline" Width="18" Height="18"
                                         Margin="0,0,6,0" VerticalAlignment="Center" />
                            <TextBlock Text="Browse Notes" VerticalAlignment="Center" />
                        </StackPanel>
                    </DataTemplate>
                </Button.ContentTemplate>
            </Button>
        </StackPanel>

        <!-- ═══════════════════════════════════ -->
        <!-- Drawer Overlay System               -->
        <!-- ═══════════════════════════════════ -->
        <Grid x:Name="DrawerOverlay"
              Grid.Row="0" Grid.RowSpan="2"
              Panel.ZIndex="10"
              Visibility="Collapsed"
              ClipToBounds="True">

            <!-- Dimmed Backdrop -->
            <Border x:Name="DrawerBackdrop"
                    Background="#66000000"
                    Opacity="0"
                    MouseLeftButtonDown="DrawerBackdrop_MouseLeftButtonDown" />

            <!-- Slide-in Drawer -->
            <Border x:Name="DrawerPanel"
                    HorizontalAlignment="Left"
                    Width="280"
                    Background="{DynamicResource MaterialDesignPaper}"
                    BorderBrush="{DynamicResource MaterialDesignDivider}"
                    BorderThickness="0,0,1,0"
                    Padding="12">
                <Border.Effect>
                    <DropShadowEffect ShadowDepth="4" Direction="0"
                                      BlurRadius="16" Opacity="0.25"
                                      Color="Black" />
                </Border.Effect>
                <Border.RenderTransform>
                    <TranslateTransform x:Name="DrawerTranslate" X="-280" />
                </Border.RenderTransform>

                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!-- Drawer Header -->
                    <DockPanel Grid.Row="0" Margin="0,0,0,8">
                        <Button DockPanel.Dock="Right"
                                Command="{Binding NewNoteCommand}"
                                Style="{StaticResource MaterialDesignRaisedButton}"
                                Padding="10,4" MinWidth="0" Height="Auto"
                                FontSize="12" Content="New" />
                        <ComboBox Width="100"
                                  ItemsSource="{Binding ScopeFilterOptions}"
                                  SelectedItem="{Binding ScopeFilter}"
                                  Style="{StaticResource MaterialDesignOutlinedComboBox}"
                                  Padding="6,3" FontSize="12" />
                    </DockPanel>

                    <Separator Grid.Row="1" Margin="0,0,0,8" />

                    <!-- Note List -->
                    <ListBox x:Name="NoteListBox"
                             Grid.Row="2"
                             ItemsSource="{Binding Notes}"
                             SelectedItem="{Binding SelectedNote}"
                             SelectionChanged="NoteListBox_SelectionChanged"
                             HorizontalContentAlignment="Stretch"
                             BorderThickness="0"
                             Background="Transparent">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border Padding="8,6" Margin="0,1">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>

                                        <!-- Title + Scope Badge -->
                                        <DockPanel Grid.Row="0">
                                            <Border DockPanel.Dock="Right"
                                                    CornerRadius="6" Padding="6,1"
                                                    VerticalAlignment="Center" Margin="6,0,0,0">
                                                <Border.Style>
                                                    <Style TargetType="Border">
                                                        <Setter Property="Background" Value="#E3F2FD" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsGlobal}" Value="True">
                                                                <Setter Property="Background" Value="#E8F5E9" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Border.Style>
                                                <TextBlock FontSize="10" FontWeight="Medium">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="Text" Value="Private" />
                                                            <Setter Property="Foreground" Value="#1565C0" />
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding IsGlobal}" Value="True">
                                                                    <Setter Property="Text" Value="Global" />
                                                                    <Setter Property="Foreground" Value="#2E7D32" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                            </Border>
                                            <TextBlock Text="{Binding Title}"
                                                       FontSize="13" FontWeight="Medium"
                                                       TextTrimming="CharacterEllipsis"
                                                       VerticalAlignment="Center" />
                                        </DockPanel>

                                        <!-- Date + Author -->
                                        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,2,0,0">
                                            <TextBlock Text="{Binding UpdatedAt, StringFormat=g}"
                                                       FontSize="11" Opacity="0.5" />
                                            <TextBlock Text=" · " FontSize="11" Opacity="0.5"
                                                       Visibility="{Binding AuthorName, Converter={StaticResource NullToCollapsedConverter}}" />
                                            <TextBlock Text="{Binding AuthorName}"
                                                       FontSize="11" Opacity="0.5"
                                                       Visibility="{Binding AuthorName, Converter={StaticResource NullToCollapsedConverter}}" />
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</UserControl>
